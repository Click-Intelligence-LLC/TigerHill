# End-to-End Integration Testing Template
# Tests complete workflow from start to finish

metadata:
  name: "integration-e2e"
  display_name: "End-to-End Integration Testing"
  description: "Test complete workflow with multiple steps and validation"
  category: "integration"
  version: "1.0.0"
  author: "TigerHill"
  tags: ["integration", "e2e", "workflow", "multi-step"]

parameters:
  - name: "agent_name"
    display_name: "Agent Name"
    description: "Name for the test agent"
    type: "string"
    required: true
    default: "my-integration-agent"
    validation:
      pattern: "^[a-zA-Z0-9_-]+$"

  - name: "workflow_name"
    display_name: "Workflow Name"
    description: "Name of the workflow being tested"
    type: "string"
    required: true
    default: "My Workflow"

  - name: "num_steps"
    display_name: "Number of Steps"
    description: "Number of workflow steps"
    type: "integer"
    required: true
    default: 3
    validation:
      min: 2
      max: 10

  - name: "use_database"
    display_name: "Use Database"
    description: "Store traces in SQLite database"
    type: "boolean"
    required: true
    default: true

dependencies:
  pip:
    - "pytest>=7.4.0"

files:
  - path: "test_{{agent_name}}.py"
    template: "main_script"
  - path: "requirements.txt"
    template: "requirements"
  - path: "README.md"
    template: "readme"

templates:
  main_script: |
    #!/usr/bin/env python3
    """
    {{ metadata.display_name }} - Generated by TigerHill

    {{ metadata.description }}
    """

    import pytest
    import time
    {% if use_database -%}
    from tigerhill.storage.sqlite_trace_store import SQLiteTraceStore
    {% else -%}
    from tigerhill.storage.trace_store import TraceStore
    {% endif -%}
    from tigerhill.storage.trace_store import EventType


    class Test{{ agent_name | camel_case }}:
        """{{ metadata.display_name }} Test Suite"""

        @pytest.fixture
        def trace_store(self{% if use_database %}, tmp_path{% endif %}):
            """Create trace store for recording"""
            {% if use_database %}
            db_path = str(tmp_path / "test.db")
            return SQLiteTraceStore(db_path=db_path, auto_init=True)
            {% else %}
            return TraceStore(storage_path="./test_traces")
            {% endif %}

        def test_{{ agent_name | snake_case }}(self, trace_store):
            """Test {{ workflow_name }}"""

            # Start trace
            trace_id = trace_store.start_trace(
                agent_name="{{ agent_name }}",
                task_id="e2e-test-{{ agent_name }}",
                metadata={
                    "workflow": "{{ workflow_name }}",
                    "num_steps": {{ num_steps }}
                }
            )

            try:
                print(f"\nüöÄ Starting workflow: {{ workflow_name }}")

                # Execute {{ num_steps }} workflow steps
                {% for i in range(num_steps) %}
                # === Step {{ i + 1 }}: [Step Name] ===
                trace_store.write_event(
                    {
                        "type": "workflow_step",
                        "step": {{ i + 1 }},
                        "name": "Step {{ i + 1 }}",
                        "status": "started"
                    },
                    trace_id=trace_id
                )

                # TODO: Implement Step {{ i + 1 }} logic here
                time.sleep(0.1)  # Simulate work

                trace_store.write_event(
                    {
                        "type": "workflow_step",
                        "step": {{ i + 1 }},
                        "name": "Step {{ i + 1 }}",
                        "status": "completed"
                    },
                    trace_id=trace_id
                )

                print(f"  ‚úÖ Step {{ i + 1 }} completed")

                {% endfor %}

                # Validate workflow completion
                trace_store.write_event(
                    {
                        "type": "validation",
                        "message": "Workflow completed successfully",
                        "steps_completed": {{ num_steps }}
                    },
                    trace_id=trace_id
                )

                print(f"\n‚úÖ Workflow completed: {{ workflow_name }}")

                # Get trace summary
                {% if use_database %}
                summary = trace_store.get_summary(trace_id)
                print(f"\nTrace Summary:")
                print(f"  Total Events: {summary['total_events']}")
                print(f"  Status: {summary['status']}")
                {% endif %}

            except Exception as e:
                trace_store.write_event(
                    {
                        "type": "error",
                        "error_message": str(e),
                        "error_type": type(e).__name__
                    },
                    trace_id=trace_id,
                    event_type=EventType.ERROR
                )
                print(f"\n‚ùå Workflow failed: {e}")
                raise

            finally:
                # End trace
                trace_store.end_trace(trace_id)


    if __name__ == "__main__":
        pytest.main([__file__, "-v", "-s"])

  requirements: |
    # Generated by TigerHill Template Library
    # Template: {{ metadata.name }}
    {% for dep in dependencies.pip -%}
    {{ dep }}
    {% endfor %}

  readme: |
    # {{ metadata.display_name }}

    {{ metadata.description }}

    ## Generated Configuration

    - **Agent Name**: `{{ agent_name }}`
    - **Workflow**: `{{ workflow_name }}`
    - **Steps**: `{{ num_steps }}`
    - **Database Storage**: `{{ 'Enabled' if use_database else 'Disabled' }}`

    ## Installation

    ```bash
    pip install -r requirements.txt
    ```

    ## Usage

    Run the test:

    ```bash
    pytest test_{{ agent_name }}.py -v -s
    ```

    {% if use_database -%}
    ## View Traces

    After running the test, view traces in the Dashboard:

    ```bash
    PYTHONPATH=. streamlit run tigerhill/web/dashboard/app.py
    ```

    Select "SQLite Database" and browse to the test database.
    {% endif -%}

    ## Customization

    Replace the TODO comments with your actual workflow logic:

    1. Define what each step does
    2. Add assertions to validate each step
    3. Add error handling for specific failure cases
    4. Customize metadata for each step

    ## Documentation

    For more information, see:
    - [TigerHill Documentation](https://github.com/yourusername/tigerhill)
    - [Integration Testing Guide](https://github.com/yourusername/tigerhill/docs/integration_testing.md)
