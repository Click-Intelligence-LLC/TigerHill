# CLI Basic Testing Template
# Tests a command-line agent with input/output validation

metadata:
  name: "cli-basic"
  display_name: "CLI Basic Testing"
  description: "Test a command-line agent with input/output validation"
  category: "cli"
  version: "1.0.0"
  author: "TigerHill"
  tags: ["cli", "command-line", "subprocess"]

parameters:
  - name: "agent_name"
    display_name: "Agent Name"
    description: "Name for the test agent"
    type: "string"
    required: true
    default: "my-cli-agent"
    validation:
      pattern: "^[a-zA-Z0-9_-]+$"

  - name: "command"
    display_name: "Command"
    description: "The CLI command to execute"
    type: "string"
    required: true

  - name: "args"
    display_name: "Command Arguments"
    description: "Command arguments (space-separated)"
    type: "string"
    required: false
    default: ""

  - name: "expected_exit_code"
    display_name: "Expected Exit Code"
    description: "Expected command exit code"
    type: "integer"
    required: true
    default: 0
    validation:
      min: 0
      max: 255

  - name: "validate_output"
    display_name: "Validate Output"
    description: "Add output validation assertions"
    type: "boolean"
    required: true
    default: true

  - name: "timeout"
    display_name: "Timeout (seconds)"
    description: "Command execution timeout"
    type: "integer"
    required: true
    default: 30
    validation:
      min: 1
      max: 300

dependencies:
  pip:
    - "pytest>=7.4.0"

files:
  - path: "test_{{agent_name}}.py"
    template: "main_script"
  - path: "requirements.txt"
    template: "requirements"
  - path: "README.md"
    template: "readme"

templates:
  main_script: |
    #!/usr/bin/env python3
    """
    {{ metadata.display_name }} - Generated by TigerHill

    {{ metadata.description }}
    """

    import pytest
    from tigerhill.adapters.cli_adapter import CLIAdapter
    from tigerhill.assertions import assert_cli_success
    from tigerhill.storage.trace_store import TraceStore


    class Test{{ agent_name | camel_case }}:
        """{{ metadata.display_name }} Test Suite"""

        @pytest.fixture
        def adapter(self):
            """Create CLI adapter"""
            return CLIAdapter(
                command="{{ command }}",
                timeout={{ timeout }}
            )

        @pytest.fixture
        def trace_store(self, tmp_path):
            """Create trace store for recording"""
            return TraceStore(storage_path=str(tmp_path))

        def test_{{ agent_name | snake_case }}(self, adapter, trace_store):
            """Test {{ metadata.display_name }}"""

            # Start trace
            trace_id = trace_store.start_trace(
                agent_name="{{ agent_name }}",
                task_id="cli-test-{{ agent_name }}",
                metadata={
                    "command": "{{ command }}",
                    "args": "{{ args }}"
                }
            )

            try:
                # Parse arguments
                {% if args %}
                args = "{{ args }}".split()
                {% else %}
                args = []
                {% endif %}
                # Execute command
                result = adapter.execute(
                    trace_id=trace_id,
                    args=args
                )

                {% if validate_output %}
                # Validate exit code
                assert result.exit_code == {{ expected_exit_code }}, \
                    f"Expected exit code {{ expected_exit_code }}, got {result.exit_code}"

                # Validate output
                assert result.stdout is not None, "stdout should not be None"

                # Log output
                trace_store.write_event(
                    {
                        "type": "cli_output",
                        "stdout": result.stdout,
                        "stderr": result.stderr,
                        "exit_code": result.exit_code
                    },
                    trace_id=trace_id
                )
                {% endif %}

                print(f"âœ… Test passed: {{ agent_name }}")
                print(f"Exit Code: {result.exit_code}")
                print(f"Output: {result.stdout[:200]}...")

            except Exception as e:
                trace_store.write_event(
                    {
                        "type": "error",
                        "error_message": str(e),
                        "error_type": type(e).__name__
                    },
                    trace_id=trace_id
                )
                raise

            finally:
                # End trace
                trace_store.end_trace(trace_id)


    if __name__ == "__main__":
        pytest.main([__file__, "-v", "-s"])

  requirements: |
    # Generated by TigerHill Template Library
    # Template: {{ metadata.name }}
    {% for dep in dependencies.pip -%}
    {{ dep }}
    {% endfor %}

  readme: |
    # {{ metadata.display_name }}

    {{ metadata.description }}

    ## Generated Configuration

    - **Agent Name**: `{{ agent_name }}`
    - **Command**: `{{ command }}`
    {% if args -%}
    - **Arguments**: `{{ args }}`
    {% endif -%}
    - **Expected Exit Code**: `{{ expected_exit_code }}`
    - **Timeout**: `{{ timeout }}` seconds

    ## Installation

    ```bash
    pip install -r requirements.txt
    ```

    ## Usage

    Run the test:

    ```bash
    pytest test_{{ agent_name }}.py -v
    ```

    ## Customization

    You can modify the generated test script to add:

    - **Input Validation**: Test different command arguments
    - **Output Assertions**: Assert specific patterns in output
    - **Error Handling**: Test error cases and stderr output
    - **Multiple Test Cases**: Add tests for different scenarios

    ## Documentation

    For more information, see:
    - [TigerHill Documentation](https://github.com/yourusername/tigerhill)
    - [CLI Adapter Reference](https://github.com/yourusername/tigerhill/docs/adapters/cli.md)
