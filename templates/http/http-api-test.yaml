# HTTP API Testing Template
# Tests a single HTTP API endpoint with request/response validation

metadata:
  name: "http-api-test"
  display_name: "HTTP API Testing"
  description: "Test an HTTP API endpoint with request/response validation"
  category: "http"
  version: "1.0.0"
  author: "TigerHill"
  tags: ["http", "api", "rest", "validation"]

parameters:
  - name: "agent_name"
    display_name: "Agent Name"
    description: "Name for the test agent"
    type: "string"
    required: true
    default: "my-api-agent"
    validation:
      pattern: "^[a-zA-Z0-9_-]+$"

  - name: "api_url"
    display_name: "API URL"
    description: "The API endpoint to test"
    type: "url"
    required: true

  - name: "http_method"
    display_name: "HTTP Method"
    description: "HTTP method for the request"
    type: "choice"
    required: true
    default: "GET"
    choices: ["GET", "POST", "PUT", "DELETE", "PATCH"]

  - name: "expected_status"
    display_name: "Expected Status Code"
    description: "Expected HTTP status code"
    type: "integer"
    required: true
    default: 200
    validation:
      min: 100
      max: 599

  - name: "request_body"
    display_name: "Request Body"
    description: "JSON request body (for POST/PUT/PATCH methods)"
    type: "json"
    required: false
    default: "{}"

  - name: "validate_response"
    display_name: "Validate Response"
    description: "Add response validation assertions"
    type: "boolean"
    required: true
    default: true

dependencies:
  pip:
    - "requests>=2.31.0"
    - "pytest>=7.4.0"

files:
  - path: "test_{{agent_name}}.py"
    template: "main_script"
  - path: "requirements.txt"
    template: "requirements"
  - path: "README.md"
    template: "readme"

templates:
  main_script: |
    #!/usr/bin/env python3
    """
    {{ metadata.display_name }} - Generated by TigerHill

    {{ metadata.description }}
    """

    import pytest
    import requests
    from tigerhill.adapters.http_adapter import HTTPAdapter
    from tigerhill.assertions import assert_http_status
    from tigerhill.storage.trace_store import TraceStore


    class Test{{ agent_name | camel_case }}:
        """{{ metadata.display_name }} Test Suite"""

        @pytest.fixture
        def adapter(self):
            """Create HTTP adapter"""
            return HTTPAdapter(
                base_url="{{ api_url }}",
                timeout=30
            )

        @pytest.fixture
        def trace_store(self, tmp_path):
            """Create trace store for recording"""
            return TraceStore(storage_path=str(tmp_path))

        def test_{{ agent_name | snake_case }}(self, adapter, trace_store):
            """Test {{ metadata.display_name }}"""

            # Start trace
            trace_id = trace_store.start_trace(
                agent_name="{{ agent_name }}",
                task_id="api-test-{{ agent_name }}",
                metadata={
                    "url": "{{ api_url }}",
                    "method": "{{ http_method }}"
                }
            )

            try:
                # Prepare request
                {% if http_method in ['POST', 'PUT', 'PATCH'] and request_body != '{}' %}
                request_body = {{ request_body }}
                {% else %}
                request_body = None
                {% endif %}
                # Execute request
                response = adapter.execute(
                    trace_id=trace_id,
                    method="{{ http_method }}",
                    endpoint="/",
                    {% if http_method in ['POST', 'PUT', 'PATCH'] and request_body != '{}' -%}
                    json=request_body,
                    {% endif -%}
                )

                {% if validate_response %}
                # Validate response
                assert_http_status(
                    response,
                    expected_status={{ expected_status }},
                    trace_id=trace_id
                )

                # Additional validations
                assert response.text is not None, "Response body should not be None"

                # Try to parse as JSON if content type indicates JSON
                content_type = response.headers.get('Content-Type', '')
                if 'application/json' in content_type:
                    try:
                        json_data = response.json()
                        trace_store.write_event(
                            {
                                "type": "validation",
                                "message": "Response is valid JSON",
                                "data": json_data
                            },
                            trace_id=trace_id
                        )
                    except ValueError as e:
                        trace_store.write_event(
                            {
                                "type": "warning",
                                "message": f"Failed to parse JSON response: {e}"
                            },
                            trace_id=trace_id
                        )
                {% endif %}

                print(f"âœ… Test passed: {{ agent_name }}")

            except Exception as e:
                trace_store.write_event(
                    {
                        "type": "error",
                        "error_message": str(e),
                        "error_type": type(e).__name__
                    },
                    trace_id=trace_id
                )
                raise

            finally:
                # End trace
                trace_store.end_trace(trace_id)


    if __name__ == "__main__":
        pytest.main([__file__, "-v", "-s"])

  requirements: |
    # Generated by TigerHill Template Library
    # Template: {{ metadata.name }}
    {% for dep in dependencies.pip -%}
    {{ dep }}
    {% endfor %}

  readme: |
    # {{ metadata.display_name }}

    {{ metadata.description }}

    ## Generated Configuration

    - **Agent Name**: `{{ agent_name }}`
    - **API URL**: `{{ api_url }}`
    - **HTTP Method**: `{{ http_method }}`
    - **Expected Status**: `{{ expected_status }}`
    {% if validate_response -%}
    - **Validation**: Enabled
    {% else -%}
    - **Validation**: Disabled
    {% endif %}

    ## Installation

    ```bash
    pip install -r requirements.txt
    ```

    ## Usage

    Run the test:

    ```bash
    pytest test_{{ agent_name }}.py -v
    ```

    View test traces:

    ```bash
    # The test automatically records traces to a temporary directory
    # For persistent traces, modify the trace_store fixture to use a fixed path
    ```

    ## Customization

    You can modify the generated test script to add:

    - **Custom Headers**: Add headers to the request
    - **Authentication**: Add authentication (Bearer token, Basic auth, etc.)
    - **Query Parameters**: Add URL query parameters
    - **Response Schema Validation**: Use `assert_response_json_schema`
    - **Multiple Test Cases**: Add more test methods

    ### Example: Adding Authentication

    ```python
    def test_{{ agent_name | snake_case }}_with_auth(self, adapter, trace_store):
        adapter.set_header("Authorization", "Bearer YOUR_TOKEN")
        # ... rest of test
    ```

    ### Example: Adding Query Parameters

    ```python
    response = adapter.execute(
        trace_id=trace_id,
        method="{{ http_method }}",
        endpoint="/",
        params={"key": "value"}
    )
    ```

    ## Documentation

    For more information, see:
    - [TigerHill Documentation](https://github.com/yourusername/tigerhill)
    - [HTTP Adapter Reference](https://github.com/yourusername/tigerhill/docs/adapters/http.md)
    - [Assertions Reference](https://github.com/yourusername/tigerhill/docs/assertions.md)
