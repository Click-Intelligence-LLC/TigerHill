# HTTP Authentication Testing Template
# Tests HTTP APIs with various authentication methods

metadata:
  name: "http-auth-test"
  display_name: "HTTP Authentication Testing"
  description: "Test HTTP APIs with Bearer token, Basic auth, or API key authentication"
  category: "http"
  version: "1.0.0"
  author: "TigerHill"
  tags: ["http", "authentication", "security", "api"]

parameters:
  - name: "agent_name"
    display_name: "Agent Name"
    description: "Name for the test agent"
    type: "string"
    required: true
    default: "my-auth-agent"
    validation:
      pattern: "^[a-zA-Z0-9_-]+$"

  - name: "api_url"
    display_name: "API URL"
    description: "The API endpoint to test"
    type: "url"
    required: true

  - name: "auth_type"
    display_name: "Authentication Type"
    description: "Type of authentication to use"
    type: "choice"
    required: true
    default: "bearer"
    choices: ["bearer", "basic", "api_key"]

  - name: "expected_status_with_auth"
    display_name: "Expected Status (with auth)"
    description: "Expected status code with valid authentication"
    type: "integer"
    required: true
    default: 200
    validation:
      min: 100
      max: 599

  - name: "expected_status_without_auth"
    display_name: "Expected Status (without auth)"
    description: "Expected status code without authentication"
    type: "integer"
    required: true
    default: 401
    validation:
      min: 100
      max: 599

dependencies:
  pip:
    - "requests>=2.31.0"
    - "pytest>=7.4.0"

files:
  - path: "test_{{agent_name}}.py"
    template: "main_script"
  - path: "requirements.txt"
    template: "requirements"
  - path: ".env.example"
    template: "env_example"
  - path: "README.md"
    template: "readme"

templates:
  main_script: |
    #!/usr/bin/env python3
    """
    {{ metadata.display_name }} - Generated by TigerHill

    {{ metadata.description }}
    """

    import os
    import pytest
    import requests
    from tigerhill.adapters.http_adapter import HTTPAdapter
    from tigerhill.assertions import assert_http_status
    from tigerhill.storage.trace_store import TraceStore, EventType


    class Test{{ agent_name | camel_case }}:
        """{{ metadata.display_name }} Test Suite"""

        @pytest.fixture
        def adapter(self):
            """Create HTTP adapter"""
            return HTTPAdapter(
                base_url="{{ api_url }}",
                timeout=30
            )

        @pytest.fixture
        def trace_store(self, tmp_path):
            """Create trace store for recording"""
            return TraceStore(storage_path=str(tmp_path))

        def test_auth_required(self, adapter, trace_store):
            """Test that authentication is required"""

            trace_id = trace_store.start_trace(
                agent_name="{{ agent_name }}",
                task_id="auth-required-test",
                metadata={
                    "test": "auth_required",
                    "auth_type": "{{ auth_type }}"
                }
            )

            try:
                # Request without authentication
                response = adapter.execute(
                    trace_id=trace_id,
                    method="GET",
                    endpoint="/"
                )

                # Should fail with {{ expected_status_without_auth }}
                assert_http_status(
                    response,
                    {{ expected_status_without_auth }},
                    trace_id=trace_id
                )

                print(f"✅ Auth required test passed: Got {{ expected_status_without_auth }} without auth")

            finally:
                trace_store.end_trace(trace_id)

        def test_auth_success(self, adapter, trace_store):
            """Test successful authentication"""

            trace_id = trace_store.start_trace(
                agent_name="{{ agent_name }}",
                task_id="auth-success-test",
                metadata={
                    "test": "auth_success",
                    "auth_type": "{{ auth_type }}"
                }
            )

            try:
                # Set up authentication
                {% if auth_type == "bearer" -%}
                # Bearer token authentication
                token = os.getenv("AUTH_TOKEN", "test-token")
                adapter.set_header("Authorization", f"Bearer {token}")

                {% elif auth_type == "basic" -%}
                # Basic authentication
                username = os.getenv("AUTH_USERNAME", "user")
                password = os.getenv("AUTH_PASSWORD", "pass")
                adapter.set_basic_auth(username, password)

                {% elif auth_type == "api_key" -%}
                # API key authentication
                api_key = os.getenv("API_KEY", "test-api-key")
                adapter.set_header("X-API-Key", api_key)

                {% endif -%}

                # Request with authentication
                response = adapter.execute(
                    trace_id=trace_id,
                    method="GET",
                    endpoint="/"
                )

                # Should succeed with {{ expected_status_with_auth }}
                assert_http_status(
                    response,
                    {{ expected_status_with_auth }},
                    trace_id=trace_id
                )

                print(f"✅ Auth success test passed: Got {{ expected_status_with_auth }} with auth")

            finally:
                trace_store.end_trace(trace_id)


    if __name__ == "__main__":
        pytest.main([__file__, "-v", "-s"])

  requirements: |
    # Generated by TigerHill Template Library
    # Template: {{ metadata.name }}
    {% for dep in dependencies.pip -%}
    {{ dep }}
    {% endfor %}

  env_example: |
    # Authentication credentials
    # Copy this file to .env and fill in your actual credentials

    {% if auth_type == "bearer" -%}
    # Bearer token
    AUTH_TOKEN=your-bearer-token-here

    {% elif auth_type == "basic" -%}
    # Basic authentication
    AUTH_USERNAME=your-username
    AUTH_PASSWORD=your-password

    {% elif auth_type == "api_key" -%}
    # API key
    API_KEY=your-api-key-here

    {% endif -%}

  readme: |
    # {{ metadata.display_name }}

    {{ metadata.description }}

    ## Generated Configuration

    - **Agent Name**: `{{ agent_name }}`
    - **API URL**: `{{ api_url }}`
    - **Auth Type**: `{{ auth_type }}`
    - **Expected Status (with auth)**: `{{ expected_status_with_auth }}`
    - **Expected Status (without auth)**: `{{ expected_status_without_auth }}`

    ## Setup

    1. **Install dependencies**:
       ```bash
       pip install -r requirements.txt
       ```

    2. **Configure authentication**:
       ```bash
       cp .env.example .env
       # Edit .env with your credentials
       ```

    3. **Load environment variables**:
       ```bash
       source .env  # or use python-dotenv
       ```

    ## Usage

    Run the tests:

    ```bash
    pytest test_{{ agent_name }}.py -v
    ```

    ## Tests

    - **test_auth_required**: Verifies that requests without auth are rejected
    - **test_auth_success**: Verifies that requests with valid auth succeed

    ## Documentation

    For more information, see:
    - [TigerHill Documentation](https://github.com/yourusername/tigerhill)
    - [HTTP Adapter Reference](https://github.com/yourusername/tigerhill/docs/adapters/http.md)
