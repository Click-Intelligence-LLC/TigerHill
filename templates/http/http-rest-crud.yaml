# REST CRUD Testing Template
# Tests full CRUD operations on a REST API

metadata:
  name: "http-rest-crud"
  display_name: "REST CRUD Testing"
  description: "Test complete CRUD operations (Create, Read, Update, Delete) on a REST API"
  category: "http"
  version: "1.0.0"
  author: "TigerHill"
  tags: ["http", "rest", "crud", "api"]

parameters:
  - name: "agent_name"
    display_name: "Agent Name"
    description: "Name for the test agent"
    type: "string"
    required: true
    default: "my-crud-agent"
    validation:
      pattern: "^[a-zA-Z0-9_-]+$"

  - name: "base_url"
    display_name: "Base URL"
    description: "Base URL of the REST API"
    type: "url"
    required: true

  - name: "resource_path"
    display_name: "Resource Path"
    description: "Resource path (e.g., /api/users)"
    type: "string"
    required: true
    default: "/api/items"

  - name: "resource_name"
    display_name: "Resource Name"
    description: "Name of the resource (e.g., user, item)"
    type: "string"
    required: true
    default: "item"

dependencies:
  pip:
    - "requests>=2.31.0"
    - "pytest>=7.4.0"

files:
  - path: "test_{{agent_name}}.py"
    template: "main_script"
  - path: "requirements.txt"
    template: "requirements"
  - path: "README.md"
    template: "readme"

templates:
  main_script: |
    #!/usr/bin/env python3
    """
    {{ metadata.display_name }} - Generated by TigerHill

    {{ metadata.description }}
    """

    import pytest
    import requests
    from tigerhill.adapters.http_adapter import HTTPAdapter
    from tigerhill.assertions import assert_http_status
    from tigerhill.storage.trace_store import TraceStore, EventType


    class Test{{ agent_name | camel_case }}:
        """{{ metadata.display_name }} Test Suite"""

        @pytest.fixture
        def adapter(self):
            """Create HTTP adapter"""
            return HTTPAdapter(
                base_url="{{ base_url }}",
                timeout=30
            )

        @pytest.fixture
        def trace_store(self, tmp_path):
            """Create trace store for recording"""
            return TraceStore(storage_path=str(tmp_path))

        def test_crud_operations(self, adapter, trace_store):
            """Test full CRUD cycle"""

            # Start trace
            trace_id = trace_store.start_trace(
                agent_name="{{ agent_name }}",
                task_id="crud-test-{{ agent_name }}",
                metadata={
                    "base_url": "{{ base_url }}",
                    "resource": "{{ resource_name }}"
                }
            )

            created_id = None

            try:
                # === CREATE ===
                create_data = {
                    "name": "Test {{ resource_name }}",
                    "description": "Created by TigerHill test"
                }

                trace_store.write_event(
                    {"type": "operation", "operation": "CREATE"},
                    trace_id=trace_id
                )

                create_response = adapter.execute(
                    trace_id=trace_id,
                    method="POST",
                    endpoint="{{ resource_path }}",
                    json=create_data
                )

                assert_http_status(create_response, 201, trace_id=trace_id)
                created_data = create_response.json()
                created_id = created_data.get("id")
                assert created_id is not None, "Created resource should have an ID"

                print(f"✅ CREATE: Created {{ resource_name }} with ID {created_id}")

                # === READ ===
                trace_store.write_event(
                    {"type": "operation", "operation": "READ"},
                    trace_id=trace_id
                )

                read_response = adapter.execute(
                    trace_id=trace_id,
                    method="GET",
                    endpoint=f"{{ resource_path }}/{created_id}"
                )

                assert_http_status(read_response, 200, trace_id=trace_id)
                read_data = read_response.json()
                assert read_data.get("id") == created_id

                print(f"✅ READ: Retrieved {{ resource_name }} {created_id}")

                # === UPDATE ===
                trace_store.write_event(
                    {"type": "operation", "operation": "UPDATE"},
                    trace_id=trace_id
                )

                update_data = {
                    "name": "Updated {{ resource_name }}",
                    "description": "Updated by TigerHill test"
                }

                update_response = adapter.execute(
                    trace_id=trace_id,
                    method="PUT",
                    endpoint=f"{{ resource_path }}/{created_id}",
                    json=update_data
                )

                assert_http_status(update_response, 200, trace_id=trace_id)

                print(f"✅ UPDATE: Updated {{ resource_name }} {created_id}")

                # === DELETE ===
                trace_store.write_event(
                    {"type": "operation", "operation": "DELETE"},
                    trace_id=trace_id
                )

                delete_response = adapter.execute(
                    trace_id=trace_id,
                    method="DELETE",
                    endpoint=f"{{ resource_path }}/{created_id}"
                )

                assert_http_status(delete_response, 204, trace_id=trace_id)

                print(f"✅ DELETE: Deleted {{ resource_name }} {created_id}")

                # Verify deletion
                verify_response = adapter.execute(
                    trace_id=trace_id,
                    method="GET",
                    endpoint=f"{{ resource_path }}/{created_id}"
                )

                assert verify_response.status_code == 404, \
                    "Deleted resource should return 404"

                print(f"✅ CRUD cycle completed successfully")

            except Exception as e:
                trace_store.write_event(
                    {
                        "type": "error",
                        "error_message": str(e),
                        "error_type": type(e).__name__
                    },
                    trace_id=trace_id,
                    event_type=EventType.ERROR
                )
                raise

            finally:
                # End trace
                trace_store.end_trace(trace_id)


    if __name__ == "__main__":
        pytest.main([__file__, "-v", "-s"])

  requirements: |
    # Generated by TigerHill Template Library
    # Template: {{ metadata.name }}
    {% for dep in dependencies.pip -%}
    {{ dep }}
    {% endfor %}

  readme: |
    # {{ metadata.display_name }}

    {{ metadata.description }}

    ## Generated Configuration

    - **Agent Name**: `{{ agent_name }}`
    - **Base URL**: `{{ base_url }}`
    - **Resource Path**: `{{ resource_path }}`
    - **Resource Name**: `{{ resource_name }}`

    ## Operations Tested

    1. **CREATE** - POST {{ resource_path }}
    2. **READ** - GET {{ resource_path }}/{id}
    3. **UPDATE** - PUT {{ resource_path }}/{id}
    4. **DELETE** - DELETE {{ resource_path }}/{id}

    ## Installation

    ```bash
    pip install -r requirements.txt
    ```

    ## Usage

    Run the test:

    ```bash
    pytest test_{{ agent_name }}.py -v
    ```

    ## Customization

    Modify `create_data` and `update_data` to match your API's schema.

    ## Documentation

    For more information, see:
    - [TigerHill Documentation](https://github.com/yourusername/tigerhill)
    - [HTTP Adapter Reference](https://github.com/yourusername/tigerhill/docs/adapters/http.md)
