# STDIO Protocol Testing Template
# Tests agents that use STDIO protocol for communication

metadata:
  name: "stdio-basic"
  display_name: "STDIO Protocol Testing"
  description: "Test agents using STDIO protocol with request/response validation"
  category: "stdio"
  version: "1.0.0"
  author: "TigerHill"
  tags: ["stdio", "protocol", "ipc"]

parameters:
  - name: "agent_name"
    display_name: "Agent Name"
    description: "Name for the test agent"
    type: "string"
    required: true
    default: "my-stdio-agent"
    validation:
      pattern: "^[a-zA-Z0-9_-]+$"

  - name: "command"
    display_name: "Agent Command"
    description: "Command to launch the agent"
    type: "string"
    required: true

  - name: "test_message"
    display_name: "Test Message"
    description: "Test message to send via STDIO"
    type: "string"
    required: true
    default: "Hello, agent!"

  - name: "timeout"
    display_name: "Timeout (seconds)"
    description: "Communication timeout"
    type: "integer"
    required: true
    default: 30
    validation:
      min: 1
      max: 300

dependencies:
  pip:
    - "pytest>=7.4.0"

files:
  - path: "test_{{agent_name}}.py"
    template: "main_script"
  - path: "requirements.txt"
    template: "requirements"
  - path: "README.md"
    template: "readme"

templates:
  main_script: |
    #!/usr/bin/env python3
    """
    {{ metadata.display_name }} - Generated by TigerHill

    {{ metadata.description }}
    """

    import pytest
    from tigerhill.adapters.stdio_adapter import STDIOAdapter
    from tigerhill.storage.trace_store import TraceStore


    class Test{{ agent_name | camel_case }}:
        """{{ metadata.display_name }} Test Suite"""

        @pytest.fixture
        def adapter(self):
            """Create STDIO adapter"""
            return STDIOAdapter(
                command="{{ command }}",
                timeout={{ timeout }}
            )

        @pytest.fixture
        def trace_store(self, tmp_path):
            """Create trace store for recording"""
            return TraceStore(storage_path=str(tmp_path))

        def test_{{ agent_name | snake_case }}(self, adapter, trace_store):
            """Test {{ metadata.display_name }}"""

            # Start trace
            trace_id = trace_store.start_trace(
                agent_name="{{ agent_name }}",
                task_id="stdio-test-{{ agent_name }}",
                metadata={
                    "command": "{{ command }}",
                    "protocol": "stdio"
                }
            )

            try:
                # Start agent process
                adapter.start()

                # Send test message
                test_message = "{{ test_message }}"

                result = adapter.send_message(
                    trace_id=trace_id,
                    message=test_message
                )

                # Validate response
                assert result is not None, "Should receive response from agent"
                assert len(result) > 0, "Response should not be empty"

                # Log interaction
                trace_store.write_event(
                    {
                        "type": "stdio_exchange",
                        "sent": test_message,
                        "received": result
                    },
                    trace_id=trace_id
                )

                print(f"âœ… Test passed: {{ agent_name }}")
                print(f"Sent: {test_message}")
                print(f"Received: {result[:200]}...")

            except Exception as e:
                trace_store.write_event(
                    {
                        "type": "error",
                        "error_message": str(e),
                        "error_type": type(e).__name__
                    },
                    trace_id=trace_id
                )
                raise

            finally:
                # Stop agent
                adapter.stop()

                # End trace
                trace_store.end_trace(trace_id)


    if __name__ == "__main__":
        pytest.main([__file__, "-v", "-s"])

  requirements: |
    # Generated by TigerHill Template Library
    # Template: {{ metadata.name }}
    {% for dep in dependencies.pip -%}
    {{ dep }}
    {% endfor %}

  readme: |
    # {{ metadata.display_name }}

    {{ metadata.description }}

    ## Generated Configuration

    - **Agent Name**: `{{ agent_name }}`
    - **Command**: `{{ command }}`
    - **Test Message**: `{{ test_message }}`
    - **Timeout**: `{{ timeout }}` seconds

    ## Installation

    ```bash
    pip install -r requirements.txt
    ```

    ## Usage

    Run the test:

    ```bash
    pytest test_{{ agent_name }}.py -v
    ```

    ## Customization

    You can modify the generated test script to add:

    - **Multiple Messages**: Test multiple request/response cycles
    - **Protocol Validation**: Validate message format (e.g., JSON-RPC)
    - **Error Handling**: Test error responses
    - **Performance Testing**: Measure latency

    ## Documentation

    For more information, see:
    - [TigerHill Documentation](https://github.com/yourusername/tigerhill)
    - [STDIO Adapter Reference](https://github.com/yourusername/tigerhill/docs/adapters/stdio.md)
